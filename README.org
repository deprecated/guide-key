* guide-key.el --- Guide following keys to an input key sequence automatically and dynamically
** Overview
guide-key.el enables to guide following keys to an input key sequence.
guide-key aims to be an alternative of [[http://emacswiki.org/emacs/one-key.el][one-key.el]].

Here are some features of this library.
- guide-key automatically pop up a window containing following keys to your
  favorite prefixes. Moreover, even if you change key bindings, guide-key
  follow its change dynamically.
- guide-key can highlight particular commands. It makes it easy to find a command
  you are looking for, and to learn its key binding.
- guide-key doesn't overwrite existing commands and key bindings. So, there
  is no bad effect on using `describe-key' and `describe-bindings'.
** Installation
I added guide-key to [[http://melpa.milkbox.net/][MELPA]]. You can install guide-key with package.el,

[[http://www.kaichan.mydns.jp/~kai/wordpress/wp-content/uploads/2012/11/wpid-guide-key-package-install.png]]

Because guide-key depends on [[https://github.com/m2ym/popwin-el][popwin.el]], popwin.el is installed at a time.

If you don't have package.el, Please download popwin.el and guide-key.el
directly from [[https://github.com/m2ym/popwin-el][m2ym/popwin-el]] and [[https://github.com/kbkbkbkb1/guide-key][kbkbkbkb1/guide-key]], and then put them in
`load-path'.
** Usage
`guide-key/guide-key-sequence' にポップアップして欲しいキーシーケンスを登録し
ます．当然複数個登録できます．
#+BEGIN_SRC emacs-lisp
(require 'guide-key)
(setq guide-key/guide-key-sequence '("C-x r" "C-x 4"))
(guide-key-mode 1)  ; guide-key-mode を有効にする
#+END_SRC
init.el にこの設定をした後 C-x r を押すと以下のようになります．

[[http://www.kaichan.mydns.jp/~kai/wordpress/wp-content/uploads/2012/11/wpid-guide-key-example.png]]
guide-key は特定の正規表現に当てはまるコマンド名に色をつけることができます．
C-x r には rectangle 系と register 系のコマンドがあります．いま rectangle 系の
コマンドに色をつけて目立たせたいとすると
#+BEGIN_SRC emacs-lisp
(setq guide-key/highlight-command-regexp "rectangle")
#+END_SRC
と設定しておけば，

[[http://www.kaichan.mydns.jp/~kai/wordpress/wp-content/uploads/2012/11/wpid-guide-key-example2.png]]

このように rectangle 系のコマンドだけが色付けされます．これでコマンドを探しや
すくなりますし，キーバインドを覚えやすくなります．rectangle 系，register 系ど
ちらも色付けしたければ
#+BEGIN_SRC emacs-lisp
(setq guide-key/highlight-command-regexp "rectangle\\|register")
#+END_SRC
のように，適当に正規表現を設定してください．またプレフィックスキー（"prefix"
という正規表現に一致するコマンド）にも自動的に色付けがされます．

guide-key の基本的な動作は以上ですが，動作を制御する変数などを説明しておきま
す．
- *(guide-key-mode ARG)*: guide-key-mode はマイナーモードで実装されています．
  対話的に実行すればトグル動作になるので，一時的に有効無効を切り替える場合は
  M-x guide-key-mode を実行してください．グローバルマイナーモードなので，特定
  のバッファのみで有効にする，といったような動作はできません．全バッファ共通で
  有効か無効かのどちらかです．
- *guide-key/popup-window-position*: ポップアップするウィンドウの位置を制御す
  る変数です．right, bottom, left, top のいずれかを指定してください．デフォル
  トは right です．
- *guide-key/polling-time*: 入力されているキーシーケンスをポーリングする間隔を
  制御する変数です．デフォルトは0.1です（秒単位）．キーを押してすぐさまポップ
  アップされるのが嫌な場合は長くするといいでしょう．おそらく0.1でもほぼ一瞬で
  表示されるように感じると思います．0.01ぐらい短くしてもきちんと動作し，他の操
  作にも影響が無いことを確認していますが，0.1で大多数の人は問題ないと思います．

guide-key が動作することを確認している環境は以下のようになります．
- Emacs 24.2, Ubuntu 12.04 or Windows 7 64bit
- Emacs 23.3, Ubuntu 12.04 or Windows 7 64bit
- Emacs 22.3, Windows 7 64bit
とにかく popwin が動けば guide-key も動作するはずです．ターミナル環境の Emacs
でも問題なく動作します．
*** 特定のモードで設定を追加
こういったキー入力を補助して欲しい場面は，おそらく新しく導入したモードに独自の
キーバインドがある場合でしょう．「さっきマニュアルを見たのに，もうキーバインド
を忘れた」ということが起きないように，以下では guide-key を使って特定のモード
に対して設定を追加します．

`guide-key/add-local-guide-key-sequence' と
`guide-key/add-local-highlight-command-regexp' を使うと現在のバッファの変数の
みを変更できます．これを特定のモードのフックと組み合わせれば，特定のモードに
対して設定を追加できます．

例えば org-mode を例にとって見ると，以下のような設定になります．
#+BEGIN_SRC emacs-lisp
(defun guide-key/my-hook-function-for-org-mode ()
  (guide-key/add-local-guide-key-sequence "C-c")
  (guide-key/add-local-guide-key-sequence "C-c C-x")
  (guide-key/add-local-guide-key-sequence "C-c C-v")
  (guide-key/add-local-highlight-command-regexp "org-"))
(add-hook 'org-mode-hook 'guide-key/my-hook-function-for-org-mode)
#+END_SRC
この設定をした後，org-mode のバッファで C-c C-x p を順番に押して
`org-set-property' が実行される様子がこれです．

[[http://www.kaichan.mydns.jp/~kai/wordpress/wp-content/uploads/2012/11/wpid-guide-key-example-org-anime.gif]]

色付けするコマンドに "org-" を追加しているので，ほとんどのコマンドが色付けさ
れています．これだとあまり意味が無いので，覚えたいコマンド群のみが色付けされ
るような正規表現（例えば "org-clock-" など）に好みで変えてください．

メジャーモードでもマイナーモードでもフックさえあれば同様のことができるので，
お好きなモードで試してみてください．
** 内部動作                                                        :noexport:
#+check
- 要はポーリング．フックはないのかね？
- ウィンドウ操作には popwin
** まとめ
既知の問題点，欠点には以下のようなものがあります．
- guide-key は次に続くキーバインドをすべて表示しようとするので，ポップアップウィ
  ンドウのサイズが大きくなりがちです．もし現在のフレームの大きさよりポップアッ
  プウィンドウの方が大きくなると，正常にポップアップされなくなります．なのでキー
  バインドの多い "C-x" などをポップアップさせるのは，全くの初心者の人以外はあ
  まりお勧めしません．将来的には，ポップアップするコマンドの方を個数や正規表現
  で制限する機能を追加するかもしれません．
- またポップアップされるキーバインドが多すぎると，目視で目的のコマンドを探すこ
  とが難しくなります．ポップアップされるコマンドの個数，あるいは色付けされたコ
  マンドの個数が数個〜十数個ぐらいになるのが理想的かと思います．
- キーバインドをポップアップさせようとした時，一瞬ポップアップされて一瞬で閉じ
  てしまうことがあります．popwin で制御されているウィンドウ（デフォルトだと
  Help バッファや Apropos バッファなど）を閉じた直後に起こることが多いですが，
  他の場面でもたまにあります．そういうときは C-g を連打したり，他のコマンドを
  実行して仕切りなおしてからもう一回プレフィックスキーを入力してみてください．
- one-key ではコマンド名の代わりに，短い説明文字列を表示させることが出来ました．
  これは手動でテンプレートを作っているからこその利点です．guide-key では動的に
  キーバインドからコマンドを抽出してくるので，コマンド名しか表示させることが
  できません．
